---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const sortedPosts = posts
    .filter(post => post.data.pubDate || post.data.date)
    .sort((a, b) => {
      const dateStrA = (a.data.pubDate || a.data.date) as string;
      const dateStrB = (b.data.pubDate || b.data.date) as string;
      const parseDate = (str: string) => {
        const match = str.match(/(\d{4})-(\d{2})-(\d{2})/);
        if (!match) return new Date(0);
        return new Date(`${match[1]}-${match[2]}-${match[3]}T00:00:00+08:00`);
      };
      const dateA = parseDate(dateStrA);
      const dateB = parseDate(dateStrB);
      return dateB.valueOf() - dateA.valueOf();
    });
  const categories = [...new Set(sortedPosts.map(post => post.data.category).filter(Boolean))];
  
  return categories.map((category) => ({
    params: { category: category },
  }));
}

const { category } = Astro.params;

const allPosts = await getCollection('blog');
const sortedPosts = allPosts
  .filter(post => post.data.pubDate || post.data.date)
  .sort((a, b) => {
    const dateStrA = (a.data.pubDate || a.data.date) as string;
    const dateStrB = (b.data.pubDate || b.data.date) as string;
    const parseDate = (str: string) => {
      const match = str.match(/(\d{4})-(\d{2})-(\d{2})/);
      if (!match) return new Date(0);
      return new Date(`${match[1]}-${match[2]}-${match[3]}T00:00:00+08:00`);
    };
    const dateA = parseDate(dateStrA);
    const dateB = parseDate(dateStrB);
    return dateB.valueOf() - dateA.valueOf();
  });

const filteredPosts = sortedPosts.filter(post => post.data.category === category);
const categories = [...new Set(sortedPosts.map(post => post.data.category).filter(Boolean))];

const formatDate = (dateStr: string | undefined) => {
  if (!dateStr) return '';
  const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (!match) return '';
  const [, year, month, day] = match;
  const date = new Date(`${year}-${month}-${day}T12:00:00+08:00`);
  const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
  const weekday = weekdays[date.getDay()];
  return `${year}-${month}-${day} (${weekday})`;
};
---

<BaseLayout title={`${category} - 文章`} description={`分类：${category} 的文章列表`} currentPath="/posts">
  <div class="post-main">
    <div class="menu-sentinel"></div>
    <div class="post-index">
      <div class="post-left-menu center-card card">
        <div class="post-left-menu-a">
          <img class="post-avatar personal-avatar" src="/img/profile-avatar.webp" width="1024" height="1024" alt="personal-avatar">
          <h2 class="post-left-menu-a-title subtitle">赤茶</h2>
          <p class="post-left-menu-a-description">Per aspera, ad astra.</p>
        </div>
        <div class="post-left-menu-b">
          <h3 class="post-left-menu-b-title subtitle">订阅文章</h3>
          <button class="post-button" onclick="window.location.href='/rss.xml'" type="button" title="RSS Feed">
            <svg class="post-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path d="M0 0h48v48H0z" fill="none"/>
              <circle cx="12.36" cy="35.64" r="4.36"/>
              <path d="M8 8.89v5.66c14.06 0 25.46 11.4 25.46 25.46h5.66C39.11 22.82 25.18 8.89 8 8.89zM8 20.2v5.66c7.81 0 14.14 6.34 14.14 14.14h5.66c0-10.93-8.87-19.8-19.8-19.8z"/>
            </svg>
          </button>
          {categories.length > 0 && (
            <>
              <div class="post-left-menu-b-space"></div>
              <h3 class="post-left-menu-b-title subtitle">文章分类</h3>
              <div class="post-left-menu-categories">
                {categories.map((cat, index) => (
                  <>
                    <a href={`/posts/category/${encodeURIComponent(cat)}`}>
                      <span class="post-left-menu-category">{cat}</span>
                    </a>
                    {index < categories.length - 1 && ' '}
                  </>
                ))}
              </div>
            </>
          )}
        </div>
      </div>

      <div class="main-content">
        <div class="post-category-header-card card">
          <div class="post-category-header-wrapper">
            <div class="post-category-header">
              <svg class="post-category-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
              </svg>
              <span class="post-category-title">{category}</span>
            </div>
          </div>
          <div class="post-category-count-wrapper">
            <div class="post-category-count">
              <svg class="post-category-count-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/>
              </svg>
              <span>共 {filteredPosts.length} 篇文章</span>
            </div>
          </div>
        </div>
        
        {filteredPosts.map((post) => (
          <div class="post-index-content card">
            <a href={`/posts/${post.slug}`} class="post-link">
              <div class="post-index-list">
                <h2 class="post-index-title">{post.data.title}</h2>
                {post.data.description && <div class="post-content">{post.data.description}</div>}
                <div class="post-info">
                  {post.data.category && <span class="post-category">{post.data.category}</span>}
                  <span class="post-time">
                    <strong>时间:</strong>
                    <time datetime={post.data.pubDate ? post.data.pubDate.replace(' ', 'T') + '+08:00' : post.data.date ? post.data.date.replace(' ', 'T') + '+08:00' : ''}>
                      {formatDate(post.data.pubDate || post.data.date)}
                    </time>
                  </span>
                </div>
              </div>
            </a>
          </div>
        ))}
        
        {filteredPosts.length === 0 && (
          <div class="post-index-content card">
            <p class="post-empty-message">该分类下暂无文章</p>
          </div>
        )}
      </div>
    </div>
  </div>
</BaseLayout>
