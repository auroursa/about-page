---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const sortedPosts = allPosts
  .filter(post => post.data.pubDate || post.data.date)
  .sort((a, b) => {
    // 将字符串日期转换为 Date 对象进行比较
    const dateStrA = (a.data.pubDate || a.data.date) as string;
    const dateStrB = (b.data.pubDate || b.data.date) as string;
    // 解析 YYYY-MM-DD HH:MM:SS 格式
    const parseDate = (str: string) => {
      const match = str.match(/(\d{4})-(\d{2})-(\d{2})/);
      if (!match) return new Date(0);
      return new Date(`${match[1]}-${match[2]}-${match[3]}T00:00:00+08:00`);
    };
    const dateA = parseDate(dateStrA);
    const dateB = parseDate(dateStrB);
    return dateB.valueOf() - dateA.valueOf();
  });

// 获取所有分类
const categories = [...new Set(sortedPosts.map(post => post.data.category).filter(Boolean))];

const formatDate = (dateStr: string | undefined) => {
  if (!dateStr) return '';
  // 解析本地时间字符串 (YYYY-MM-DD HH:MM:SS)
  const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (!match) return '';
  const [, year, month, day] = match;
  
  // 计算星期
  const date = new Date(`${year}-${month}-${day}T12:00:00+08:00`);
  const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
  const weekday = weekdays[date.getDay()];
  
  return `${year}-${month}-${day} (${weekday})`;
};
---

<BaseLayout title="文章" description="博客文章列表" currentPath="/posts">
  <div class="post-main">
    <div class="menu-sentinel"></div>
    <div class="post-index">
      <!-- 左侧边栏 -->
      <div class="post-left-menu center-card card">
        <div class="post-left-menu-a">
          <img class="post-avatar personal-avatar" src="/img/profile-avatar.webp" width="1024" height="1024" alt="personal-avatar">
          <h2 class="post-left-menu-a-title subtitle">赤茶</h2>
          <p class="post-left-menu-a-description">Per aspera, ad astra.</p>
        </div>
        <div class="post-left-menu-b">
          <h3 class="post-left-menu-b-title subtitle">订阅文章</h3>
          <button class="post-button" onclick="window.location.href='/rss.xml'" type="button" title="RSS Feed">
            <svg class="post-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path d="M0 0h48v48H0z" fill="none"/>
              <circle cx="12.36" cy="35.64" r="4.36"/>
              <path d="M8 8.89v5.66c14.06 0 25.46 11.4 25.46 25.46h5.66C39.11 22.82 25.18 8.89 8 8.89zM8 20.2v5.66c7.81 0 14.14 6.34 14.14 14.14h5.66c0-10.93-8.87-19.8-19.8-19.8z"/>
            </svg>
          </button>
          {categories.length > 0 && (
            <>
              <div class="post-left-menu-b-space"></div>
              <h3 class="post-left-menu-b-title subtitle">文章分类</h3>
              <div class="post-left-menu-categories">
                {categories.map((cat, index) => (
                  <>
                    <a href="#"><span class="post-left-menu-category">{cat}</span></a>
                    {index < categories.length - 1 && ' '}
                  </>
                ))}
              </div>
            </>
          )}
        </div>
      </div>

      <!-- 右侧文章列表 -->
      <div class="main-content">
        {sortedPosts.map((post) => (
          <div class="post-index-content card">
            <a href={`/posts/${post.slug}`} class="post-link">
              <div class="post-index-list">
                <h2 class="post-index-title">{post.data.title}</h2>
                {post.data.description && <div class="post-content">{post.data.description}</div>}
                <div class="post-info">
                  {post.data.category && <span class="post-category">{post.data.category}</span>}
                  <span class="post-time">
                    <strong>时间:</strong>
                    <time datetime={(post.data.pubDate || post.data.date) ? (post.data.pubDate || post.data.date).replace(' ', 'T') + '+08:00' : ''}>
                      {formatDate(post.data.pubDate || post.data.date)}
                    </time>
                  </span>
                </div>
              </div>
            </a>
          </div>
        ))}
      </div>
    </div>
  </div>
</BaseLayout>
