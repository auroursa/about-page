---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { entry: post },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const formatDate = (dateStr: string | undefined) => {
  if (!dateStr) return '';
  // 解析本地时间字符串 (YYYY-MM-DD HH:MM:SS)
  const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (!match) return '';
  const [, year, month, day] = match;
  
  // 计算星期
  const date = new Date(`${year}-${month}-${day}T12:00:00+08:00`);
  const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
  const weekday = weekdays[date.getDay()];
  
  return `${year}-${month}-${day} (${weekday})`;
};
---

<BaseLayout title={entry.data.title} description={entry.data.description} currentPath="/posts">
  <main class="post-article-main">
    <div class="menu-sentinel"></div>
    
    <!-- 文章区域 -->
    <article class="post-article card">
      <div>
        <h1 class="post-article-title">{entry.data.title}</h1>
      </div>
      <div class="post-article-content">
        <Content />
      </div>
    </article>

    <!-- 文章尾部信息 -->
    <div class="post-article-footer">
      <!-- 本文信息 -->
      <div class="post-article-meta card">
        <h2 class="card-title">本文信息</h2>
        <p><strong>作者: </strong>赤茶</p>
        <p>
          <strong>发布时间:</strong>
          <time class="published" datetime={entry.data.pubDate ? entry.data.pubDate.replace(' ', 'T') + '+08:00' : ''}>
            {formatDate(entry.data.pubDate)}
          </time>
        </p>
        {entry.data.category && (
          <p><strong>文章分类: </strong>{entry.data.category}</p>
        )}
        <p>
          <strong>链接: </strong>
          <a href={`/posts/${entry.slug}`} title={entry.data.title} class="p-link">
            https://cynosura.one/posts/{entry.slug}
          </a>
        </p>
      </div>

      <!-- 版权许可 -->
      <div class="post-article-copyright card">
        <h2 class="card-title">版权许可</h2>
        <p><strong>声明: </strong>本文所有内容（包括图片）</p>
        <p>
          均采用 
          <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank" title="Creative Commons Attribution-ShareAlike 4.0 International License">
            CC BY-SA 4.0
          </a> 
          协议授权
        </p>
        <p>转载请注明出处，并附上本声明内容</p>
        <svg class="post-article-copyright-icon" version="1.1" viewBox="0 0 96 96" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
          <g>
            <path d="M47.358,0.004C20.85,0.357-0.351,22.133,0.004,48.641c0.354,26.507,22.129,47.71,48.637,47.354 c26.506-0.354,47.71-22.129,47.354-48.638C95.642,20.85,73.862-0.352,47.358,0.004z M48.506,85.892 c-20.928,0.279-38.119-16.459-38.398-37.388C9.829,27.578,26.567,10.387,47.493,10.107C68.42,9.828,85.61,26.564,85.891,47.492 C86.17,68.421,69.432,85.61,48.506,85.892z M36.254,56.132c-2.027,0-3.562-0.738-4.602-2.219c-1.041-1.479-1.559-3.45-1.559-5.915 c0-5.42,2.053-8.131,6.16-8.131c0.82,0,1.711,0.273,2.668,0.82c0.957,0.549,1.766,1.508,2.424,2.875l6.16-3.203 c-2.463-4.436-6.545-6.654-12.24-6.654c-3.889,0-7.104,1.287-9.648,3.861c-2.547,2.574-3.822,6.051-3.822,10.432 c0,4.491,1.262,7.997,3.779,10.517s5.834,3.777,9.941,3.777c2.572,0,4.928-0.645,7.062-1.93c2.135-1.287,3.807-3.053,5.012-5.299 l-5.67-2.876C40.825,54.817,38.936,56.132,36.254,56.132z M62.786,56.132c-2.027,0-3.561-0.738-4.6-2.219 c-1.041-1.479-1.561-3.45-1.561-5.915c0-5.42,2.053-8.131,6.16-8.131c0.875,0,1.793,0.273,2.75,0.82 c0.959,0.549,1.768,1.508,2.426,2.875l6.076-3.203c-2.41-4.436-6.461-6.654-12.156-6.654c-3.889,0-7.105,1.287-9.652,3.861 c-2.545,2.574-3.816,6.051-3.816,10.432c0,4.491,1.244,7.997,3.736,10.517c2.49,2.52,5.818,3.777,9.98,3.777 c2.518,0,4.846-0.645,6.98-1.93c2.135-1.287,3.832-3.053,5.094-5.299l-5.75-2.876C67.358,54.817,65.467,56.132,62.786,56.132z"/>
          </g>
        </svg>
        <svg class="post-article-copyright-icon" viewBox="0 0 496 512" xmlns="http://www.w3.org/2000/svg">
          <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3 3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7 3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256 0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8 103.2 0 202.8-81.1 202.8-202.8.1-113.8-90.2-203.3-202.8-203.3z"/>
        </svg>
        <svg class="post-article-copyright-icon" viewBox="0 0 496 512" xmlns="http://www.w3.org/2000/svg">
          <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256 0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8 103.2 0 202.8-81.1 202.8-202.8.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7 99.8 0 127.5 82.5 127.5 134.2 0 63.6-41 132.9-128.9 132.9-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2 23.3 0 58-18.2 58-82.8 0-82.5-49.1-80.6-56.7-80.6-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2-49-49.2h19.4z"/>
        </svg>
      </div>
    </div>

    <!-- 评论区域（在 footer 外面，独立一整行） -->
    <div class="post-article-comments card">
      <h2 class="card-title">评论</h2>
      <p>注: 留言系统基于 <a href="https://disqus.com">Disqus</a>，部分网络环境可能无法正常加载。</p>
      <div id="disqus_thread"></div>
      <button id="load_disqus" class="comments-button button" aria-labelledby="load_comments">
        <span id="load_comments">加载评论</span>
      </button>
      <div id="disqus_thread_container"></div>
    </div>
  </main>

  <script is:inline data-astro-rerun data-cfasync="false">
    // Disqus 加载按钮处理
    // ClientRouter 时，此脚本会在每次页面导航后重新执行
    // 但事件监听器使用事件委托绑定在 document 上，只需要绑定一次
    
    (function() {
      // 只在第一次执行时绑定事件监听器
      if (window.__disqusClickHandlerInstalled) {
        return;
      }
      window.__disqusClickHandlerInstalled = true;
      
      // 使用事件委托处理点击
      document.addEventListener('click', function(e) {
        // 检查是否点击了加载评论按钮
        var btn = e.target.closest('#load_disqus');
        if (!btn) return;
        
        // 检查按钮是否已被处理
        if (btn.dataset.loaded === 'true') return;
        btn.dataset.loaded = 'true';
        
        // 加载 Disqus
        var disqusScript = document.createElement('script');
        disqusScript.src = 'https://cynosura-one.disqus.com/embed.js';
        disqusScript.setAttribute('data-timestamp', String(+new Date()));
        document.head.appendChild(disqusScript);
        
        // 移动 disqus_thread 到容器
        var disqusContainer = document.getElementById('disqus_thread_container');
        var disqusThread = document.getElementById('disqus_thread');
        if (disqusContainer && disqusThread) {
          disqusContainer.appendChild(disqusThread);
        }
        
        // 隐藏按钮
        btn.style.display = 'none';
      });
    })();
  </script>
</BaseLayout>
